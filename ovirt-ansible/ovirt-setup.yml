---

- name: preset vm for ovirt-engine
  hosts: all
  vars_files:
    - vars/conf_vars.yml

  tasks:
    - name: set /etc/hosts file
      blockinfile:
        dest: /etc/hosts
        block: |
          192.168.122.237    ovirt-engine.example.com    ovirt-engine
          192.168.122.9    ovirt-host1.example.com     ovirt-host1
          192.168.122.10    ovirt-host2.example.com    ovirt-host2
    
    - name: Disable NetworkManager
      service:
        name: NetworkManager
        enabled: no
    - name: Enabled and start network
      service:
        name: network
        state: started
        enabled: yes

    - name: install lvm, dnsmasq and targetcli
      yum:
        name: "{{ item }}"
        state: latest
      with_items:
        - dnsmasq
        - targetcli
        - lvm2

    - name: update dnsmasq config
      blockinfile:
        dest: /etc/dnsmasq.conf
        block: |
          address=/ovirt-engine.example.com/192.168.122.237
          address=/ovirt-host1.example.com/192.168.122.9
          address=/ovirt-host2.example.com/192.168.122.10
          server=192.168.122.1

    - name: start and enable dnsmasq
      service:
        name: dnsmasq
        state: started
        enabled: yes
    - name: update resolv.conf
      copy:
        content: nameserver 127.0.0.1
        dest: /etc/resolv.conf
       
    - name: vg setup
      lvg:
        vg: "{{ vg_name }}"
        pvs: /dev/vdb
    - name: lv setup
      lvol: 
        vg: "{{ vg_name }}"
        lv: "{{ lv_name }}"
        size: 19G

    - name: Set iscsi configuration
      template:
        src: templates/saveconfig.json.j2
        dest: /etc/target/saveconfig.json
        owner: root
        group: root
        mode: 0644

    - name: Start and enabled targetcli
      service:
        name: target
        state: started
        enabled: yes


      


